#!/bin/bash
if [ `./xmlquery --value MACH` == mira ]; then
  # for "small" runs on 1024 nodes
  if [ `./xmlquery --value ATM_NTASKS` == 2700 ]; then
    ./xmlchange --file env_run.xml --id PIO_STRIDE --val -99
    ./xmlchange --file env_run.xml --id CPL_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id ATM_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id ICE_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id OCN_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id LND_PIO_NUMTASKS --val 8
    ./xmlchange --file env_run.xml --id ROF_PIO_NUMTASKS --val 8
    ./xmlchange --file env_run.xml --id GLC_PIO_NUMTASKS --val 1
    ./xmlchange --file env_run.xml --id WAV_PIO_NUMTASKS --val 1
    ./xmlchange --file env_run.xml --id ESP_PIO_NUMTASKS --val 1

    ./xmlchange --file env_batch.xml --id JOB_WALLCLOCK_TIME --val 04:30:00

  # "medium" or "any" runs on 2048 nodes
  elif [ `./xmlquery --value ATM_NTASKS` == 5400 ]; then
    ./xmlchange --file env_run.xml --id PIO_STRIDE --val -99
    ./xmlchange --file env_run.xml --id CPL_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id ATM_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id ICE_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id OCN_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id LND_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id ROF_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id GLC_PIO_NUMTASKS --val 1
    ./xmlchange --file env_run.xml --id WAV_PIO_NUMTASKS --val 1
    ./xmlchange --file env_run.xml --id ESP_PIO_NUMTASKS --val 1

  # "large" runs on 4096 nodes
  elif [ `./xmlquery --value ATM_NTASKS` == 10800 ]; then
    ./xmlchange --file env_run.xml --id PIO_STRIDE --val -99
    ./xmlchange --file env_run.xml --id CPL_PIO_NUMTASKS --val 32
    ./xmlchange --file env_run.xml --id ATM_PIO_NUMTASKS --val 32
    ./xmlchange --file env_run.xml --id ICE_PIO_NUMTASKS --val 32
    ./xmlchange --file env_run.xml --id OCN_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id LND_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id ROF_PIO_NUMTASKS --val 16
    ./xmlchange --file env_run.xml --id GLC_PIO_NUMTASKS --val 1
    ./xmlchange --file env_run.xml --id WAV_PIO_NUMTASKS --val 1
    ./xmlchange --file env_run.xml --id ESP_PIO_NUMTASKS --val 1

    ./xmlchange --file env_batch.xml --id JOB_WALLCLOCK_TIME --val 02:00:00
  fi

./xmlchange --file env_run.xml --id CPL_PIO_TYPENAME --val netcdf

# cosp_lite requires larger stack size
cp env_mach_specific.xml env_mach_specific.xml.orig
sed s/OMP_STACKSIZE=64M/OMP_STACKSIZE=128M/ env_mach_specific.xml.orig >env_mach_specific.xml
./xmlchange --id CAM_CONFIG_OPTS --append -val " -cosp"
cat <<EOF >> user_nl_cam
cosp_lite = .true.
EOF

fi

